clear all 
close all
addpath(genpath('..\YALMIP-master'))
addpath(genpath('C:\Program Files\Mosek'))
clc

%% Data-driven dissipativity verification for a mass-spring-damper system
T = 0.5; %sampling time
m = 1; %mass
k = 1; %spring
d = 1; %damper

dim_x = 2; %state dimensions
dim_u = 1; %input dimensions

%L2-gain as (Q,S,R)-dissipativity
gamma_square = sdpvar(1); %upper bound L2-gain
Q = -[1 0; 0 0]; %y=[1 0]x
S = zeros(dim_x,dim_u);
R = gamma_square*eye(dim_u);

X = sdpvar(dim_x); %storage function x'*X*x

%% L2-gain of true system 

%State space representation of Euler-discretization of m*y''+d*y'+k*y=u
A = [1 T; -k/m*T -d/m*T+1];
B = [0; T];

%Build dissipativity inequality [x;u]'*Omega*[x;u]>=0
phi = [A B;
       eye(dim_x) zeros(dim_x,dim_u);
       eye(dim_x) zeros(dim_x,dim_u);
       zeros(dim_u,dim_x) eye(dim_u)];  
Psi = blkdiag(blkdiag(-X,X), [Q S; S' R]);
Omega = phi'*Psi*phi;
   
eps = 10^-4;
F_c = [X>=0, Omega-eps*eye(length(Omega(1,:)))>=0]; %LMI constraints for SDP
 
options = sdpsettings('solver','mosek');
sol_opt = optimize(F_c, gamma_square, options) %solve SDP

gamma_true = value(sqrt(gamma_square))

%% Data generation for data-driven dissipativity verification
L = 20; %experiment length (time steps)
t = 0:T:L*T; %experiment length (continuous time)
u_sample = cos(0.1*t(1:end)); %experiment input
D = length(u_sample(1,:)); %number of samples
x0 = [0; 0]; %experiment initial condition
noise = 2; %noise=1:||d||_infty<=epsilon, noise=2:||d||_2<=epsilon
epsilon = 0.01;
sys = 1;

x_sample = simulate_system(sys, u_sample, x0, noise, epsilon); %simulate system

figure
plot(t,x_sample(1,1:end-1)) %plot position of mass


%reduce data length to S=7
%u_sample = u_sample(1:7);
%x_sample = x_sample(:,1:8);
%D = 7;

%reduce data length to S=5
%u_sample = u_sample(1:5);
%x_sample = x_sample(:,1:6);
%D = 5;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%% save Data %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%epsilon = 0.002;
%x_sample = [0,-0.000500028161871412,0.250884415292693,0.624450770782931,0.997145556681367,1.27435104913363,1.40972198326193,1.39978607260797,1.28207433935015,1.11015081109994,0.931886694071818,0.790850860906897,0.707153113826612,0.681474275335179,0.698357080672337,0.735382096648103,0.771959957790450,0.790156796235955,0.780310833726943,0.741702123444500,0.683705303661813,0.614720081933256;0,0.500111088780521,0.748506802505912,0.746884671173728,0.554151796138173,0.268388468811564,-0.0197784672680105,-0.237052405304027,-0.347129583190647,-0.354810240454568,-0.281656247596850,-0.167859158858282,-0.0533623721425800,0.0314152523928918,0.0741886488991432,0.0703439428586236,0.0327590076868541,-0.0206458302409228,-0.0749170365648399,-0.117362556008336,-0.138736934903766,-0.140868565809958];
%u_sample = [1,0.998750260394966,0.995004165278026,0.988771077936042,0.980066577841242,0.968912421710645,0.955336489125606,0.939372712847379,0.921060994002885,0.900447102352677,0.877582561890373,0.852524522059506,0.825335614909678,0.796083798549056,0.764842187284488,0.731688868873821,0.696706709347165,0.659983145884982,0.621609968270664,0.581683089463884,0.540302305868140];

%epsilon = 0.005;
%x_sample = [0,0.00367330293854449,0.249663696869468,0.624648685717320,0.999250715326783,1.27658498347765,1.41106767230117,1.40109074200217,1.28163757545397,1.10540009470982,0.923368364958011,0.779481760777544,0.696077268711479,0.672596632427268,0.692531544222670,0.733505013957798,0.773897479754580,0.793224483736998,0.783182795762950,0.748603039073851,0.686522890126383,0.618371993607847;0,0.496956211456017,0.744931484502956,0.746108732509643,0.555271985946360,0.268233189223301,-0.0205526912471172,-0.238497639300784,-0.352416253473753,-0.356460144376312,-0.283251997652213,-0.166803104162662,-0.0468737139141745,0.0410468342182852,0.0831273241472819,0.0799159196143175,0.0385849995088900,-0.0192768274199255,-0.0726461214504493,-0.117419075546849,-0.140203202027438,-0.142231343531869];
%u_sample = [1,0.998750260394966,0.995004165278026,0.988771077936042,0.980066577841242,0.968912421710645,0.955336489125606,0.939372712847379,0.921060994002885,0.900447102352677,0.877582561890373,0.852524522059506,0.825335614909678,0.796083798549056,0.764842187284488,0.731688868873821,0.696706709347165,0.659983145884982,0.621609968270664,0.581683089463884,0.540302305868140];

%epsilon = 0.01;
%x_sample = [0,-0.000354869499418552,0.251717114683490,0.614289800324041,0.990491961858912,1.26846675237783,1.40979499165431,1.40077533441195,1.27635145333768,1.10900924957040,0.930875102321607,0.801522068571899,0.721597299933832,0.685655434982603,0.695142201443788,0.726781746872798,0.759580157088230,0.786772436734648,0.785958840943529,0.757904349709403,0.688029284012623,0.622654481002567;0,0.500166162684637,0.740383761934217,0.741318147041810,0.558608384350199,0.272821652120425,-0.0141501437759872,-0.229504844600700,-0.343148347733938,-0.341791916133931,-0.268834260066713,-0.165585680447835,-0.0601298351865956,0.0145323708837630,0.0667300216683242,0.0697627454187967,0.0407062633222617,-0.0127980832203080,-0.0698338680198165,-0.120278199633063,-0.146173863331613,-0.152708067167646];
%u_sample = [1,0.998750260394966,0.995004165278026,0.988771077936042,0.980066577841242,0.968912421710645,0.955336489125606,0.939372712847379,0.921060994002885,0.900447102352677,0.877582561890373,0.852524522059506,0.825335614909678,0.796083798549056,0.764842187284488,0.731688868873821,0.696706709347165,0.659983145884982,0.621609968270664,0.581683089463884,0.540302305868140];

% epsilon = 0.02;
% x_sample = [0,-0.0142076651256302,0.238568491552932,0.617392353784085,1.01359214404336,1.28400978611003,1.41733578741781,1.41787623962603,1.30121336742167,1.11366576755724,0.947022512384951,0.819832934735646,0.725814979454403,0.685167985357074,0.691364680726072,0.724093386695584,0.754042897569183,0.770312560956210,0.774256220812709,0.732059918159221,0.686047605711543,0.612511515522843;0,0.499879784670641,0.750863834417869,0.758390388192453,0.565179089399953,0.279401929979650,-0.00676487303325756,-0.231111529183879,-0.356192795179306,-0.354325427638693,-0.278663295570572,-0.188616450613655,-0.0767768704311257,0.0228445061532959,0.0645980126906945,0.0524886938316609,0.0309705750851803,-0.00436703311888061,-0.0524119548049006,-0.106724257484509,-0.139919007862661,-0.144941096407277];
% u_sample = [1,0.998750260394966,0.995004165278026,0.988771077936042,0.980066577841242,0.968912421710645,0.955336489125606,0.939372712847379,0.921060994002885,0.900447102352677,0.877582561890373,0.852524522059506,0.825335614909678,0.796083798549056,0.764842187284488,0.731688868873821,0.696706709347165,0.659983145884982,0.621609968270664,0.581683089463884,0.540302305868140];

% epsilon = 0.03;
% x_sample = [0,0.0195369968570061,0.241785535459373,0.617278264638169,1.00838963211968,1.26460735208869,1.39392019520714,1.41444686977058,1.32721743923356,1.14687744464749,0.948343139814725,0.798810692612902,0.728562637873515,0.697438747522482,0.696921516016285,0.696904215290842,0.728875120124602,0.738806709302453,0.752022644264501,0.708110809008150,0.641550632635755,0.561899959268841;0,0.479162675382028,0.752781103017839,0.752767373634477,0.563749590388560,0.264311060796959,-0.00898305426053576,-0.223079377701527,-0.351255965843716,-0.396977587399602,-0.321654595663563,-0.194725158850184,-0.0695272739150902,-0.00646054441676341,0.0350561453820841,0.0586710229199192,0.0399221967481015,0.0177790710104899,-0.0596546081824764,-0.116279572564019,-0.122538372388192,-0.102877000721205];
% u_sample = [1,0.998750260394966,0.995004165278026,0.988771077936042,0.980066577841242,0.968912421710645,0.955336489125606,0.939372712847379,0.921060994002885,0.900447102352677,0.877582561890373,0.852524522059506,0.825335614909678,0.796083798549056,0.764842187284488,0.731688868873821,0.696706709347165,0.659983145884982,0.621609968270664,0.581683089463884,0.540302305868140];

%epsilon = 0.04;
%x_sample = [0,0.00677838853968739,0.246869937097572,0.625376110947984,0.974392156785041,1.23991234366890,1.41332799106694,1.40411663367586,1.32204463799246,1.16774820035652,0.990365182920149,0.833455807526173,0.733961408856551,0.689171538513920,0.658638595262749,0.690336053723175,0.728858975296335,0.748081690163125,0.752291414462424,0.734465517763698,0.695998165546538,0.633819182951208;0,0.493208875463725,0.719588466169232,0.738055271862546,0.520869526267772,0.300312878623791,0.0376632476818154,-0.205960044802914,-0.356486251783255,-0.351870092964147,-0.311756620940398,-0.198872792659738,-0.0900654535540561,-0.0324685575800757,0.0516278657371036,0.0655028986768005,0.0464367906984974,0.0281590763488760,-0.0360252401086191,-0.0806248890500769,-0.119558072544539,-0.138935671691105];
%u_sample = [1,0.998750260394966,0.995004165278026,0.988771077936042,0.980066577841242,0.968912421710645,0.955336489125606,0.939372712847379,0.921060994002885,0.900447102352677,0.877582561890373,0.852524522059506,0.825335614909678,0.796083798549056,0.764842187284488,0.731688868873821,0.696706709347165,0.659983145884982,0.621609968270664,0.581683089463884,0.540302305868140];

%epsilon = 0.05;
%x_sample = [0,-0.0313785862531084,0.230479244756359,0.620852376486810,1.04055923763207,1.31894583545300,1.43995411646121,1.41102483055342,1.27445262484445,1.10917762775951,0.927761422384806,0.793049598350027,0.723618549742948,0.685089830719791,0.700419196554169,0.704818582319741,0.713128127103381,0.686196018133750,0.686692435622522,0.637644036004096,0.617581022529371,0.577876996803336;0,0.535720912789072,0.747309757524982,0.766901851953914,0.547025675207615,0.247888567475649,-0.0517938552117472,-0.265281922249159,-0.361276612277341,-0.362507623923263,-0.270533609853343,-0.160174273380917,-0.0751527303465063,0.0179547361246711,0.0681238221028477,0.0770429306236666,0.0214063421130552,0.0334174547295289,-0.0198881809596860,-0.0733904836366641,-0.0425535618411639,-0.0779350236657734]
%u_sample = [1,0.998750260394966,0.995004165278026,0.988771077936042,0.980066577841242,0.968912421710645,0.955336489125606,0.939372712847379,0.921060994002885,0.900447102352677,0.877582561890373,0.852524522059506,0.825335614909678,0.796083798549056,0.764842187284488,0.731688868873821,0.696706709347165,0.659983145884982,0.621609968270664,0.581683089463884,0.540302305868140];

%% L2-gain from data
%%%%%%%%%%%%%%%%%%%%%%%%%% Set membership %%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%% Following Proposition 2 of arXiv:2108.11298v3 %%%%%%%
% Build LMI for ellipsoidal outer approximation
Delta1_i = {};
Delta2_i = {}; 
Delta3_i = {};

mutliplier = sdpvar(D,1); %mutliplier
data_ellip = zeros(3*dim_x+2*dim_u,3*dim_x+2*dim_u);
for i = 1:D
    z_i = [x_sample(:,i); u_sample(:,i)];
    
    Delta1_i{i} = z_i*z_i';
    Delta2_i{i} = -z_i*x_sample(:,i+1)'; 
    Delta3_i{i} = x_sample(:,i+1)*x_sample(:,i+1)'-epsilon^2*eye(dim_x);

    data_ellip = data_ellip+mutliplier(i)*[Delta1_i{i} Delta2_i{i} zeros(dim_x+dim_u,dim_x+dim_u); Delta2_i{i}' Delta3_i{i} zeros(dim_x,dim_x+dim_u); zeros(dim_x+dim_u,3*dim_x+2*dim_u)];
end

% ellipsoidal outer approximation
Delta1_tilde = sdpvar(dim_x+dim_u); 
Delta2_tilde = sdpvar(dim_x+dim_u,dim_x); 

eps_elli = 10^-6;
options = sdpsettings('solver','mosek');

%Minimize diameter
%lambda_min = sdpvar(1);
%Out_approx = [mutliplier>=0, Delta1_tilde>=lambda_min*eye(dim_x+dim_u), [Delta1_tilde Delta2_tilde zeros(dim_x+dim_u,dim_x+dim_u); Delta2_tilde' -eye(dim_x) Delta2_tilde';  zeros(dim_x+dim_u, dim_x+dim_u) Delta2_tilde -Delta1_tilde]-data_ellip<=-eps_elli*eye(3*dim_x+2*dim_u) ];
%diagnostics = optimize(Out_approx, -lambda_min, options)

%Minimize volumne
Out_approx = [mutliplier>=0, Delta1_tilde>=0, [Delta1_tilde Delta2_tilde zeros(dim_x+dim_u,dim_x+dim_u); Delta2_tilde' -eye(dim_x) Delta2_tilde';  zeros(dim_x+dim_u, dim_x+dim_u) Delta2_tilde -Delta1_tilde]-data_ellip<=-eps_elli*eye(3*dim_x+2*dim_u) ];
diagnostics = optimize(Out_approx, -geomean(Delta1_tilde), options)


Delta1_tilde = value(Delta1_tilde);
Delta2_tilde = value(Delta2_tilde);
Delta3_tilde = Delta2_tilde'*inv(Delta1_tilde)*Delta2_tilde-eye(dim_x);

%ellipsoidal outer approximation in dual space [[A B]'; eye]'*Delta_tilde*[[A B]'; eye]<=0
Delta_tilde = [Delta1_tilde Delta2_tilde; Delta2_tilde' Delta3_tilde];

%ellipsoidal outer approximation in primal space [eye; [A B]]'*Delta*[eye; [A B]]<=0
Delta = inv([-Delta1_tilde Delta2_tilde; Delta2_tilde' -Delta3_tilde]); 

%%%%%%%%%%%%%%%%%%%%% Dissipativity verification %%%%%%%%%%%%%%%%%%%%%%
alpha = sdpvar(1); %multiplier S-procedure 

%Build dissipativity inequality [x;u;w]'*Omega*[x;u;w]>=0
phi = [zeros(dim_x,dim_x+dim_u) eye(dim_x); %dynamics
       eye(dim_x) zeros(dim_x,dim_u+dim_x); %state
       eye(dim_x+dim_u) zeros(dim_x+dim_u,dim_x); %state+input (dissipativity)
       eye(dim_x+dim_u) zeros(dim_x+dim_u,dim_x); %state+input (w)
       zeros(dim_x,dim_x+dim_u) eye(dim_x); %w
       ];
Psi = blkdiag(blkdiag(-X,X), [Q S; S' R], alpha*Delta);
Omega = phi'*Psi*phi;
   
F_c = [X>=0, Omega-eps*eye(length(Omega(1,:)))>=0, alpha>=0]; %LMI constraints for SDP

options = sdpsettings('solver','mosek');
sol_opt = optimize(F_c, gamma_square, options) %solve SDP

gamma_dd = value(sqrt(gamma_square))

%% L2-gain inferences 

epsilon = [0.002 0.005 0.01 0.02 0.03 0.04 0.05];

L2_dd_21 = [2.0737 2.1913 2.4155 3.4997 3.9369 4.8391 17.8649];
L2_dd_7 = [2.0781 2.2150 2.4377 3.7784 4.5400 5.3513 39.9161];
L2_dd_5 = [2.1372 2.3570 2.7639 4.7414 11.1124 inf inf];


figure
plot(epsilon,gamma_true*ones(1,length(epsilon)))
grid on
hold on
plot(epsilon,L2_dd_21,'-*')
plot(epsilon,L2_dd_7,'--*')
plot(epsilon,L2_dd_5,'--*')
axis([min(epsilon) 0.045 0 10]);
legend('Model-based', 'Data-driven S=21', 'Data-driven S=7', 'Data-driven S=5')
xlabel('\epsilon')
ylabel('\gamma')


